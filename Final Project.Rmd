---
title: "Final Project"
author: "Leah Schultz"
date: "12/20/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning = FALSE, message = FALSE}
library(dplyr)
library(lme4)
library(ggplot2)
library(merTools)
library(sjPlot)
library(broom)
library(tidyr)
library(lcmm)
library(plyr)
oysup <- read.csv("~/1-descriptives-and-graphs-leahschultz/oysup_teacher_self.csv")
purpose <- read.csv("~/Dropbox/Lab & Research/OYSUP Project/oysup_self.csv")
oysup <- oysup %>%
  dplyr::select(FAMID, extra_7s:extra_10s, agree_7s:agree_10s, consc_7s:consc_10s, neuro_7s:neuro_10s,
                open_7s:open_10s,extra_7t:extra_10t, agree_7t:agree_10t, consc_7t:consc_10t,
                neuro_7t:neuro_10t, open_7t:open_10t)
dems <- purpose %>%
  dplyr::select(SEX2, MPEDUC2)
oysup <- cbind(oysup, dems)
```

First, restructuring data:

```{r}
oysup_long <- tbl_df(oysup) %>%
  gather(c(-FAMID, -SEX2, -MPEDUC2), key = "grade", value = "value") %>%
  separate(grade, into = c("variable", "grade"), sep = "_", convert = T) %>%
  separate(grade, into = c("grade", "source"), sep = -2) %>%
  mutate(grade = as.numeric(grade)) %>%
  spread(variable, value)
oysup_long
oysup_long$grade2 <- oysup_long$grade^2
```

I want to use latent class mixed models to understand trends occurring in personality change, both from student- and teacher-reports. It is clear that not everyone is changing in the same ways during this time, but are there distinct clusters of students changing in specific ways?

```{r}
model_1 <- lcmm(fixed = extra ~ grade + grade2, 
                   random = ~grade, nwg = FALSE, subject = "FAMID",
                   ng=1, idiag=FALSE, link="linear",data=oysup_long)

model_2 <- lcmm(fixed = extra ~ grade + grade2, 
                   mixture = ~grade, nwg = FALSE, subject = "FAMID",
                   ng=2, idiag=FALSE, link="linear",data=oysup_long)

model_3 <- lcmm(fixed = extra ~ grade + grade2, 
                   mixture = ~grade, nwg = FALSE, subject = "FAMID",
                   ng=3, idiag=FALSE, link="linear",data=oysup_long)

model_4 <- lcmm(fixed = extra ~ grade + grade2, 
                   mixture = ~grade, nwg = FALSE, subject = "FAMID",
                   ng=4, idiag=FALSE, link="linear",data=oysup_long)

model_5 <- lcmm(fixed = extra ~ grade + grade2, 
                   mixture = ~grade, nwg = FALSE, subject = "FAMID",
                   ng=5, idiag=FALSE, link="linear",data=oysup_long)
```

```{r}
summarytable(model_1, model_2, model_3, model_4, model_5)
```
Wow, this summary table is super helpful. To my eye, it looks as if the 3-class model makes the most sense for the data. But let's look at how many subjects are in each class (since it gives percentages but not #s).

```{r}

# How many subjects per class in 2-class model?
pp_model2 <- postprob(model_2) 
pp_model2[1]

# How many subjects per class in 3-class model?
pp_model3 <- postprob(model_3) 
pp_model3[1]

# How many subjects per class in 4-class model?
pp_model4 <- postprob(model_4) 
pp_model4[1]

# What percent of subjects in each class have posterior probabilities above thresholds (specified in the function)?
pp_model2[2:3]
pp_model3[2:3]
pp_model4[2:3]
```

Upon second inspection, it seems that class 4 will work well.

```{r}
#First, we need a data frame that specifies which class subjects are in
membership <- as.data.frame(matrix(nrow=966,ncol=4))
colnames(membership) <- c("ID","Class_2","Class_3","Class_4")
membership[,1:2] <- model_2$pprob[,1:2]
membership[,3:4] <- c(model_3$pprob[,2], model_4$pprob[,2])

#Recode into classes with meaningful names
#NOTE: Class 1 in the 2 class model will not necessary be the "same" 
# (i.e. have the same trajectory) as Class 1 and 2 in the 3 class model.
membership$Class_2 <- as.character(membership$Class_2)
membership$Class_2 <- revalue(membership$Class_2, c("1"="Stable_High","2"="Stable_Low"))
membership$Class_3 <- as.character(membership$Class_3)
membership$Class_3 <- revalue(membership$Class_3, c("1"="Stable_Middle","2"="Stable_High","3"="Stable_Low"))
membership$Class_4 <- as.character(membership$Class_4)
membership$Class_4 <- revalue(membership$Class_4, c("1"="Stable_Middle","2"="Stable_Low"
                                                    ,"3"="Stable_High","4"="Stable_VeryLow"))

oysup_long <- merge(membership,oysup_long)

#2 class model
plot_2 <- ggplot(oysup_long[oysup_long2$Class_2 %in% c("Stable_High","Stable_Low"), ],
       aes(x = grade,y = extra, group = FAMID,color=Class_2)) + 
  geom_line(alpha=0.25) + 
  geom_smooth(aes(group=Class_2),method="loess",size=1.5,se=T,linetype="longdash")
plot_2

#3 class model
plot_3 <- ggplot(oysup_long[oysup_long3$Class_3 %in% c("Stable_High","Stable_Low"), ],
       aes(x = grade,y = extra, group = FAMID,color=Class_2)) + 
  geom_line(alpha=0.25) + 
  geom_smooth(aes(group=Class_2),method="loess",size=1.5,se=T,linetype="longdash")
plot_3

#4 class model
plot_2 <- ggplot(oysup_long[oysup_long2$Class_2 %in% c("Stable_High","Stable_Low"), ],
       aes(x = grade,y = extra, group = FAMID,color=Class_2)) + 
  geom_line(alpha=0.25) + 
  geom_smooth(aes(group=Class_2),method="loess",size=1.5,se=T,linetype="longdash")
plot_2
```
